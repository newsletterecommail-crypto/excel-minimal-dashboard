<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Listing Webform + Dashboard (GitHub-only)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;max-width:980px}
    label{display:block;margin-top:10px;font-weight:600}
    input[type=text], input[type=password], textarea, select{width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px}
    button{margin-top:12px;padding:10px 14px;border-radius:8px;border:0;background:#0b6df0;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .status{margin-top:10px;padding:8px;border-radius:6px;background:#f3f4f6}
    .card{border:1px solid #eee;padding:12px;border-radius:8px;margin-top:12px}
    .small{font-size:13px;color:#555}
    code{background:#f4f4f5;padding:2px 4px;border-radius:4px}
    .btn-ghost{background:#eee;color:#222}
    table{border-collapse:collapse;width:100%;font-size:13px}
    th,td{border:1px solid #ddd;padding:6px;text-align:left}
    th{background:#f3f4f6}
    #reveal-admin { cursor:pointer; position:relative; z-index:9999; user-select:none; }
  </style>
  <!-- Chart.js for dashboard chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Listing Webform (no login) + Dashboard</h1>

<!-- Admin toggle -->
<div style="margin-top:8px">
  <button id="reveal-admin" class="btn-ghost" type="button"
    onclick="(function(btn){
      const ghCard = document.getElementById('gh-card');
      const ghNote = document.getElementById('gh-note');
      const shown = ghCard && ghCard.style.display === 'block';
      if(shown){
        if(ghCard) ghCard.style.display='none';
        if(ghNote) ghNote.style.display='none';
        btn.textContent='Show admin settings';
      } else {
        if(ghCard) ghCard.style.display='block';
        if(ghNote) ghNote.style.display='block';
        btn.textContent='Hide admin settings';
        const tok = document.getElementById('gh-token'); if(tok) tok.focus();
      }
    })(this)">Show admin settings</button>
</div>

<div id="gh-note" class="small muted">
  Enter GitHub owner, repo and a Personal Access Token (PAT) with <code>repo</code> scope.
  The PAT stays in your browser only. Do not share it publicly.
</div>

<div class="card" id="gh-card">
  <label>GitHub owner / org (your username)</label>
  <input id="gh-owner" type="text" placeholder="your-github-username-or-org" />

  <label>Repository name</label>
  <input id="gh-repo" type="text" placeholder="your-repo" />

  <label>Personal Access Token (with repo scope)</label>
  <input id="gh-token" type="password" placeholder="paste a token with repo access" />
  <div class="muted">
    Used only in the browser to call GitHub API. Not stored on a server.
  </div>
</div>

<!-- FORM + DASHBOARD -->
<div id="forms">
  <!-- FORM -->
  <div class="card">
    <h3>Submit Listing</h3>
    <div class="small muted">
      Anyone can fill this form. On submit, a JSON file is saved to
      <code>data/entries/&lt;timestamp&gt;-&lt;slug&gt;.json</code> in the repo.
    </div>
    <form id="data-form" style="margin-top:8px">
      <label>Your name / email (for reference)</label>
      <input name="submitter" id="submitter" type="text" />

      <label>Comp Brand Name*</label><input name="Comp Brand Name*" type="text" />
      <label>Comp Store Name*</label><input name="Comp Store Name*" type="text" />
      <label>SKU*</label><input name="SKU*" type="text" />
      <label>Comp DESIGN/TYPE</label><input name="Comp DESIGN/TYPE" type="text" />
      <label>ASIN*</label><input name="ASIN*" type="text" />
      <label>Link*</label><input name="Link*" type="text" />
      <label>ASIN REV*</label><input name="ASIN REV*" type="text" />
      <label>Variation?*</label><input name="Variation?*" type="text" />
      <label>LISTING REV*</label><input name="LISTING REV*" type="text" />
      <label>Comp RANK*</label><input name="Comp RANK*" type="text" />
      <label>Product Short Name*</label><input name="Product Short Name*" type="text" />
      <label>Price*</label><input name="Price*" type="text" />
      <label>Coupon %*</label><input name="Coupon %*" type="text" />
      <label>Coupon PRICE*</label><input name="Coupon PRICE*" type="text" />
      <label>Price After Coupon*</label><input name="Price After Coupon*" type="text" />

      <div class="row">
        <div class="col">
          <button id="submit-btn" type="button">Submit (save to GitHub)</button>
        </div>
        <div class="col muted" style="align-self:center">
          Saved files go to:
          <code>data/entries/&lt;timestamp&gt;-&lt;slug&gt;.json</code>
        </div>
      </div>
    </form>
    <div id="submit-status" class="status" style="display:none"></div>
  </div>

  <!-- DASHBOARD -->
  <div class="card" id="dashboard-card">
    <h3>Dashboard (all entries)</h3>
    <div class="small muted">
      Uses the same PAT to read files under <code>data/entries/</code>. Anyone with this page + PAT can refresh.
    </div>

    <div style="margin-top:8px">
      <button id="dash-refresh" class="btn-ghost" type="button">Refresh dashboard</button>
    </div>

    <div id="dash-status" class="status" style="display:none"></div>

    <div id="dash-summary" style="margin-top:8px">
      <div>Total entries: <strong><span id="dash-total">0</span></strong></div>
      <div>Average price: <strong><span id="dash-avgprice">-</span></strong></div>
    </div>

    <div style="margin-top:12px">
      <canvas id="dash-price-chart" height="200"></canvas>
    </div>

    <div style="margin-top:12px;max-height:260px;overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Created At</th>
            <th>Product Short Name</th>
            <th>Brand</th>
            <th>Price</th>
            <th>Comp Store</th>
            <th>SKU</th>
          </tr>
        </thead>
        <tbody id="dash-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="global-status" class="status" style="display:none"></div>

<script>
// Hide admin card on load
(function(){
  const ghCard = document.getElementById('gh-card');
  const ghNote = document.getElementById('gh-note');
  if(ghCard) ghCard.style.display = 'none';
  if(ghNote) ghNote.style.display = 'none';
})();

/* Simple GitHub-only app:
   - Anyone can submit form
   - Each submit writes JSON under data/entries/
   - Dashboard reads all entries and shows:
       • total count
       • average Price*
       • bar chart of Price* by Product Short Name
       • table of entries
*/

(async function(){
  // --- helpers
  const qs = s => document.querySelector(s);
  const show = (sel, msg, err=false) => {
    const el = qs(sel);
    if(!el) return;
    el.style.display='block';
    el.textContent = msg;
    el.style.background = err ? '#ffecec' : '#eef7ff';
  };
  const hide = sel => { const el = qs(sel); if(el) el.style.display='none'; };
  const nowTs = ()=> new Date().toISOString().replace(/[:.]/g,'-');
  const slugify = s => (s||'entry').toString().toLowerCase().trim()
                      .replace(/[^a-z0-9]+/g,'-')
                      .replace(/(^-|-$)/g,'');
  const b64 = s => btoa(unescape(encodeURIComponent(s)));
  const fromB64 = s => decodeURIComponent(escape(atob(s.replace(/\n/g,''))));

  function ownerRepoCheck(){
    const owner = qs('#gh-owner')?.value?.trim() || '';
    const repo  = qs('#gh-repo')?.value?.trim() || '';
    const token = qs('#gh-token')?.value?.trim() || '';
    if(!owner || !repo || !token) {
      throw new Error('Enter GitHub owner, repo and PAT in "admin settings" at the top.');
    }
    return { owner, repo, token };
  }

  async function ghGet(path){
    const { owner, repo, token } = ownerRepoCheck();
    const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
    const r = await fetch(url, { headers: { Authorization:'token ' + token, Accept:'application/vnd.github.v3+json' }});
    if(!r.ok) throw r;
    return r.json();
  }

  async function ghPut(path, message, content_b64, sha){
    const { owner, repo, token } = ownerRepoCheck();
    const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
    const body = { message, content: content_b64 };
    if(sha) body.sha = sha;
    const r = await fetch(url, {
      method:'PUT',
      headers:{ Authorization:'token ' + token, Accept:'application/vnd.github.v3+json' },
      body: JSON.stringify(body)
    });
    if(!r.ok) throw r;
    return r.json();
  }

  async function ghListDir(path){
    const { owner, repo, token } = ownerRepoCheck();
    const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
    const r = await fetch(url, { headers:{ Authorization:'token ' + token, Accept:'application/vnd.github.v3+json' }});
    if(!r.ok) throw r;
    return r.json();
  }

  // --- Submit listing
  qs('#submit-btn').addEventListener('click', async ()=>{
    hide('#submit-status'); hide('#global-status');
    try{
      ownerRepoCheck(); // throws if missing
      show('#submit-status','Preparing submission...');

      const form = qs('#data-form');
      const data = {};
      Array.from(form.elements).forEach(inp => {
        if(inp.name) data[inp.name] = inp.value || '';
      });

      const title = data['Product Short Name*'] || data['Comp Brand Name*'] || 'entry';
      const filename = nowTs() + '-' + slugify(title) + '.json';
      const path = 'data/entries/' + filename;

      const payload = {
        _meta:{
          createdAt: new Date().toISOString(),
          createdBy: data['submitter'] || ''
        },
        data
      };

      const content = b64(JSON.stringify(payload, null, 2));
      show('#submit-status','Saving entry to repo: ' + path);

      try{
        await ghPut(path, 'Add entry: ' + title, content);
      }catch(err){
        const msg = (err && err.status) ? `Create file failed (HTTP ${err.status}). Check repo / PAT.` : 'Create file failed.';
        show('#submit-status', msg, true);
        return;
      }

      show('#submit-status','Saved successfully.');

      // Keep submitter, clear other fields
      const submitterKeep = data['submitter'] || '';
      Array.from(form.elements).forEach(inp=>{
        if(!inp.name) return;
        if(inp.name === 'submitter') inp.value = submitterKeep;
        else inp.value = '';
      });

      // Refresh dashboard
      try { await loadDashboard(); } catch(e){ console.warn('Dashboard refresh failed', e); }

    }catch(err){
      show('#submit-status','Error: ' + (err.message || err), true);
    }
  });

  // --- DASHBOARD LOGIC ---
  let dashChart = null;

  async function loadDashboard(){
    hide('#dash-status');
    const statusEl = qs('#dash-status');
    const tbody = qs('#dash-tbody');
    if(tbody) tbody.innerHTML = '';
    try{
      ownerRepoCheck(); // ensure admin filled owner/repo/token

      if(statusEl){ statusEl.style.display='block'; statusEl.textContent='Loading dashboard data...'; statusEl.style.background='#eef7ff'; }

      // list files
      const list = await ghListDir('data/entries')
        .catch(e=>{ throw new Error('Could not list data/entries. Make sure folder exists and PAT has repo access.'); });

      const jsonFiles = Array.isArray(list)
        ? list.filter(i=>i.type === 'file' && i.name.endsWith('.json'))
        : [];

      const allEntries = [];
      for(const f of jsonFiles){
        try{
          const file = await ghGet('data/entries/' + f.name);
          const raw = fromB64(file.content);
          const j = JSON.parse(raw);
          allEntries.push({ name: f.name, ...j });
        }catch(e){
          console.warn('Skip invalid entry', f.name, e);
        }
      }

      // Summary stats
      const total = allEntries.length;
      const prices = allEntries
        .map(e => parseFloat(e.data?.['Price*'] || e.data?.Price || ''))
        .filter(v => !isNaN(v) && v>0);

      const avgPrice = prices.length
        ? (prices.reduce((a,b)=>a+b,0) / prices.length)
        : null;

      qs('#dash-total').textContent = total;
      qs('#dash-avgprice').textContent = avgPrice ? avgPrice.toFixed(2) : '-';

      // Table rows
      if(tbody){
        allEntries
          .sort((a,b) => (a._meta?.createdAt || '').localeCompare(b._meta?.createdAt || ''))
          .forEach(e=>{
            const d = e.data || {};
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${e._meta?.createdAt || ''}</td>
              <td>${d['Product Short Name*'] || ''}</td>
              <td>${d['Comp Brand Name*'] || ''}</td>
              <td>${d['Price*'] || ''}</td>
              <td>${d['Comp Store Name*'] || ''}</td>
              <td>${d['SKU*'] || ''}</td>
            `;
            tbody.appendChild(tr);
          });
      }

      // Chart: price by product short name (last 20 entries)
      const ctx = document.getElementById('dash-price-chart');
      if(window.Chart && ctx){
        const chartData = allEntries
          .filter(e => !isNaN(parseFloat(e.data?.['Price*'] || '')))
          .slice(-20); // last 20
        const labels = chartData.map(e => e.data?.['Product Short Name*'] || e.name);
        const dataVals = chartData.map(e => parseFloat(e.data?.['Price*'] || '0'));

        if(dashChart){ dashChart.destroy(); }
        dashChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Price',
              data: dataVals,
            }]
          },
          options: {
            responsive:true,
            plugins:{ legend:{ display:false } },
            scales:{ y:{ beginAtZero:true } }
          }
        });
      }

      if(statusEl){ statusEl.textContent='Dashboard updated'; statusEl.style.background='#eef7ff'; }

    }catch(err){
      if(statusEl){
        statusEl.style.display='block';
        statusEl.textContent = 'Dashboard error: ' + (err.message || err);
        statusEl.style.background='#ffecec';
      }
    }
  }

  // Bind refresh button
  qs('#dash-refresh').addEventListener('click', async ()=>{
    await loadDashboard();
  });

  // Try to load dashboard once on page load (will show nice error if PAT not set yet)
  try{ await loadDashboard(); }catch(e){ console.warn('Initial dashboard load failed (likely no PAT yet).', e); }

})();
</script>

</body>
</html>
