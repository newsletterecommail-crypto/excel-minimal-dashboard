<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Excel -> GitHub Webform (No Login)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;max-width:980px}
    label{display:block;margin-top:10px;font-weight:600}
    input[type=text], input[type=password], textarea, select{width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px}
    button{margin-top:12px;padding:10px 14px;border-radius:8px;border:0;background:#0b6df0;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .status{margin-top:10px;padding:8px;border-radius:6px;background:#f3f4f6}
    .card{border:1px solid #eee;padding:12px;border-radius:8px;margin-top:12px}
    .small{font-size:13px;color:#555}
    code{background:#f4f4f5;padding:2px 4px;border-radius:4px}
    .btn-ghost{background:#eee;color:#222}
    .entry{border:1px solid #ddd;padding:8px;border-radius:6px;margin-top:8px}
    #reveal-admin { cursor:pointer; position:relative; z-index:9999; user-select:none; }
  </style>
</head>
<body>

<h1>Excel → GitHub Webform (GitHub-only, no login)</h1>

<!-- Admin toggle -->
<div style="margin-top:8px">
  <button id="reveal-admin" class="btn-ghost" type="button"
    onclick="(function(btn){
      const ghCard = document.getElementById('gh-card');
      const ghNote = document.getElementById('gh-note');
      const shown = ghCard && ghCard.style.display === 'block';
      if(shown){
        if(ghCard) ghCard.style.display='none';
        if(ghNote) ghNote.style.display='none';
        btn.textContent='Show admin settings';
      } else {
        if(ghCard) ghCard.style.display='block';
        if(ghNote) ghNote.style.display='block';
        btn.textContent='Hide admin settings';
        const tok = document.getElementById('gh-token'); if(tok) tok.focus();
      }
    })(this)">Show admin settings</button>
</div>

<div id="gh-note" class="small muted">
  Everything is GitHub-only. Enter GitHub owner, repo and a Personal Access Token (PAT) with <code>repo</code> scope.
  Keep the repo private and the PAT secret.
</div>

<div class="card" id="gh-card">
  <label>GitHub owner / org (your username)</label>
  <input id="gh-owner" type="text" placeholder="your-github-username-or-org" />

  <label>Repository name</label>
  <input id="gh-repo" type="text" placeholder="your-repo" />

  <label>Personal Access Token (with repo scope)</label>
  <input id="gh-token" type="password" placeholder="paste a token with repo access" />
  <div class="muted">
    Token is used only in your browser to call the GitHub API. It is not stored on any server.
  </div>
</div>

<!-- MAIN FORM (always visible, no login) -->
<div id="forms">
  <div class="card">
    <h3>Submit Listing (Junior)</h3>
    <div class="small muted">
      Fill the details below and click "Submit". A JSON file will be saved to
      <code>data/entries/&lt;timestamp&gt;-&lt;slug&gt;.json</code> in the repo.
    </div>
    <form id="data-form" style="margin-top:8px">
      <!-- you can put your own email/identifier here -->
      <label>Your email / name (for reference)</label>
      <input name="submitterEmail" id="submitterEmail" type="text" />

      <label>Comp Brand Name*</label><input name="Comp Brand Name*" type="text" />
      <label>Comp Store Name*</label><input name="Comp Store Name*" type="text" />
      <label>SKU*</label><input name="SKU*" type="text" />
      <label>Comp DESIGN/TYPE</label><input name="Comp DESIGN/TYPE" type="text" />
      <label>ASIN*</label><input name="ASIN*" type="text" />
      <label>Link*</label><input name="Link*" type="text" />
      <label>ASIN REV*</label><input name="ASIN REV*" type="text" />
      <label>Variation?*</label><input name="Variation?*" type="text" />
      <label>LISTING REV*</label><input name="LISTING REV*" type="text" />
      <label>Comp RANK*</label><input name="Comp RANK*" type="text" />
      <label>Product Short Name*</label><input name="Product Short Name*" type="text" />
      <label>Price*</label><input name="Price*" type="text" />
      <label>Coupon %*</label><input name="Coupon %*" type="text" />
      <label>Coupon PRICE*</label><input name="Coupon PRICE*" type="text" />
      <label>Price After Coupon*</label><input name="Price After Coupon*" type="text" />
      <label>Junior Listing Owner* (name or email)</label><input name="Junior Listing Owner*" type="text" />
      <label>Senior Listing Owner* (GitHub username for assignment; optional)</label><input name="Senior Listing Owner*" type="text" />

      <div class="row">
        <div class="col">
          <button id="submit-btn" type="button">Submit (save to GitHub &amp; create Issue if possible)</button>
        </div>
        <div class="col muted" style="align-self:center">
          Saved files go to:
          <code>data/entries/&lt;timestamp&gt;-&lt;slug&gt;.json</code>
        </div>
      </div>
    </form>
    <div id="submit-status" class="status" style="display:none"></div>
  </div>

  <!-- Reviewer panel (for seniors/admins with PAT) -->
  <div class="card" id="reviewer-card">
    <h3>Reviewer Panel (Senior/Admin)</h3>
    <div class="small muted">
      With a PAT that has <code>repo</code> scope, click "Load pending entries".
      Approve/Reject will update the entry file in <code>data/entries/</code> and, if an Issue exists, comment on it.
    </div>
    <div style="margin-top:8px">
      <button id="load-pending" class="btn-ghost">Load pending entries</button>
    </div>
    <div id="pending-list" style="margin-top:8px"></div>
  </div>
</div>

<div id="global-status" class="status" style="display:none"></div>

<script>
// Hide admin card on load
(function(){
  const ghCard = document.getElementById('gh-card');
  const ghNote = document.getElementById('gh-note');
  if(ghCard) ghCard.style.display = 'none';
  if(ghNote) ghNote.style.display = 'none';
})();

/* GitHub-only flow:
   - Save submissions as JSON files under data/entries/
   - Optionally create an Issue for each submission
   - Reviewer can Approve/Reject from the list of pending entries
*/

(async function(){
  // --- helpers
  const qs = s => document.querySelector(s);
  const show = (sel, msg, err=false) => {
    const el = qs(sel);
    if(!el) return;
    el.style.display='block';
    el.textContent = msg;
    el.style.background = err ? '#ffecec' : '#eef7ff';
  };
  const hide = sel => { const el = qs(sel); if(el) el.style.display='none'; };
  const nowTs = ()=> new Date().toISOString().replace(/[:.]/g,'-');
  const slugify = s => (s||'entry').toString().toLowerCase().trim()
                      .replace(/[^a-z0-9]+/g,'-')
                      .replace(/(^-|-$)/g,'');
  const b64 = s => btoa(unescape(encodeURIComponent(s)));
  const fromB64 = s => decodeURIComponent(escape(atob(s.replace(/\n/g,''))));

  function ownerRepoCheck(){
    const owner = qs('#gh-owner')?.value?.trim() || '';
    const repo  = qs('#gh-repo')?.value?.trim() || '';
    const token = qs('#gh-token')?.value?.trim() || '';
    if(!owner || !repo || !token) {
      throw new Error('Enter GitHub owner, repo and PAT in "admin settings" at the top.');
    }
    return { owner, repo, token };
  }

  async function ghGet(path){
    const { owner, repo, token } = ownerRepoCheck();
    const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
    const r = await fetch(url, { headers: { Authorization:'token ' + token, Accept:'application/vnd.github.v3+json' }});
    if(!r.ok) throw r;
    return r.json();
  }

  async function ghPut(path, message, content_b64, sha){
    const { owner, repo, token } = ownerRepoCheck();
    const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
    const body = { message, content: content_b64 };
    if(sha) body.sha = sha;
    const r = await fetch(url, {
      method:'PUT',
      headers:{ Authorization:'token ' + token, Accept:'application/vnd.github.v3+json' },
      body: JSON.stringify(body)
    });
    if(!r.ok) throw r;
    return r.json();
  }

  async function ghPostIssues(title, body, assignees){
    const { owner, repo, token } = ownerRepoCheck();
    const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/issues`;
    const payload = { title, body };
    if(assignees && assignees.length) payload.assignees = assignees;
    const r = await fetch(url, {
      method:'POST',
      headers:{ Authorization:'token ' + token, Accept:'application/vnd.github.v3+json' },
      body: JSON.stringify(payload)
    });
    if(!r.ok) throw r;
    return r.json();
  }

  async function ghPostIssueComment(number, bodyText){
    const { owner, repo, token } = ownerRepoCheck();
    const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/issues/${number}/comments`;
    const r = await fetch(url, {
      method:'POST',
      headers:{ Authorization:'token ' + token, Accept:'application/vnd.github.v3+json' },
      body: JSON.stringify({ body: bodyText })
    });
    if(!r.ok) throw r;
    return r.json();
  }

  async function ghListDir(path){
    const { owner, repo, token } = ownerRepoCheck();
    const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
    const r = await fetch(url, { headers:{ Authorization:'token ' + token, Accept:'application/vnd.github.v3+json' }});
    if(!r.ok) throw r;
    return r.json();
  }

  // --- Submit listing
  qs('#submit-btn').addEventListener('click', async ()=>{
    hide('#submit-status'); hide('#global-status');
    try{
      ownerRepoCheck(); // throws if missing
      show('#submit-status','Preparing submission...');

      const form = qs('#data-form');
      const data = {};
      Array.from(form.elements).forEach(inp => {
        if(inp.name) data[inp.name] = inp.value || '';
      });

      const title = data['Product Short Name*'] || data['Comp Brand Name*'] || 'entry';
      const filename = nowTs() + '-' + slugify(title) + '.json';
      const path = 'data/entries/' + filename;

      const payload = {
        _meta:{
          createdAt: new Date().toISOString(),
          createdBy: data['Junior Listing Owner*'] || data['submitterEmail'] || ''
        },
        status: 'Pending',
        data
      };

      const content = b64(JSON.stringify(payload, null, 2));
      show('#submit-status','Saving entry to repo: ' + path);

      // create file
      let createRes = null;
      try{
        createRes = await ghPut(path, 'Add entry: ' + title, content);
      }catch(err){
        const msg = (err && err.status) ? `Create file failed (HTTP ${err.status}). Check repo / PAT.` : 'Create file failed.';
        show('#submit-status', msg, true);
        return;
      }

      // create issue to notify senior (if possible)
      const seniorUsername = (data['Senior Listing Owner*'] || '').trim();
      const issueTitle = 'Approval Request: ' + title;
      const issueBody =
`A new entry was submitted by **${data['Junior Listing Owner*'] || data['submitterEmail'] || 'junior'}**.

**Summary**
${data['Product Short Name*'] || ''}

Entry file: ${path}

Please review and comment APPROVE or REJECT.`;

      let issue = null;
      try{
        issue = await ghPostIssues(issueTitle, issueBody, seniorUsername ? [seniorUsername] : []);
      }catch(err){
        console.warn('Issue create failed', err);
      }

      // attach issue number to entry file if created
      if(issue && issue.number){
        try{
          const entryFile = await ghGet(path);
          const raw = fromB64(entryFile.content);
          const j = JSON.parse(raw);
          j.issueNumber = issue.number;
          j.issueUrl = issue.html_url;
          const newContent = b64(JSON.stringify(j, null, 2));
          await ghPut(path, 'Attach issue #' + issue.number + ' to entry', newContent, entryFile.sha);
        }catch(err){
          console.warn('Failed to attach issue number to entry', err);
        }
      }

      show('#submit-status',
        'Saved. ' + (issue ? ('Issue created: #' + issue.number) : 'No issue created (check PAT permissions or repo Issues settings).')
      );

      // Clear form except submitter email & junior name
      const submitterKeep = data['submitterEmail'] || '';
      const juniorKeep = data['Junior Listing Owner*'] || submitterKeep;
      Array.from(form.elements).forEach(inp=>{
        if(!inp.name) return;
        if(inp.name === 'submitterEmail') inp.value = submitterKeep;
        else if(inp.name === 'Junior Listing Owner*') inp.value = juniorKeep;
        else inp.value = '';
      });

    }catch(err){
      show('#submit-status','Error: ' + (err.message || err), true);
    }
  });

  // --- Reviewer: load pending entries
  qs('#load-pending').addEventListener('click', async ()=>{
    hide('#global-status');
    const listDiv = qs('#pending-list');
    listDiv.innerHTML = 'Loading...';
    try{
      ownerRepoCheck(); // ensure admin fields set

      const list = await ghListDir('data/entries')
        .catch(e=>{ throw new Error('Could not list data/entries. Make sure folder exists and PAT has repo access.'); });

      const jsonFiles = Array.isArray(list)
        ? list.filter(i=>i.type === 'file' && i.name.endsWith('.json'))
        : [];

      const pending = [];
      for(const f of jsonFiles){
        try{
          const file = await ghGet('data/entries/' + f.name);
          const raw = fromB64(file.content);
          const j = JSON.parse(raw);
          if(j.status === 'Pending'){
            pending.push({
              name: f.name,
              path: 'data/entries/' + f.name,
              sha: file.sha,
              entry: j
            });
          }
        }catch(e){
          console.warn('Skip invalid entry', f.name, e);
        }
      }

      if(pending.length === 0){
        listDiv.innerHTML = '<div class="small muted">No pending entries found.</div>';
        return;
      }

      listDiv.innerHTML = '';
      pending.forEach((p, idx)=>{
        const d = p.entry.data || {};
        const container = document.createElement('div');
        container.className = 'entry';
        container.innerHTML = `
          <div><strong>${d['Product Short Name*'] || d['Comp Brand Name*'] || p.name}</strong> — ${p.name}</div>
          <div class="small">
            Submitted by: ${p.entry._meta?.createdBy || 'unknown'}
            — Created: ${p.entry._meta?.createdAt || ''}
          </div>
          <div style="margin-top:6px">
            ${Object.keys(d).slice(0,6).map(k=>`<div><strong>${k}:</strong> ${d[k]}</div>`).join('')}
          </div>
          <div style="margin-top:8px">
            <button class="approve" data-idx="${idx}">Approve</button>
            <button class="reject" data-idx="${idx}" style="margin-left:8px;background:#d33">Reject</button>
          </div>
        `;
        listDiv.appendChild(container);

        container.querySelector('.approve').addEventListener('click', async ()=>{ await decide(p, 'Approved'); });
        container.querySelector('.reject').addEventListener('click', async ()=>{ await decide(p, 'Rejected'); });
      });

    }catch(err){
      listDiv.innerHTML = '';
      show('#global-status','Load failed: ' + (err.message || err), true);
    }
  });

  // --- Decide: approve / reject
  async function decide(p, decision){
    try{
      show('#global-status', decision + ' in progress...');
      const file = await ghGet(p.path);
      const raw = fromB64(file.content);
      const j = JSON.parse(raw);

      j.status = decision;
      j.decidedBy = 'reviewer';          // you can change this manually if needed
      j.decisionAt = new Date().toISOString();

      const newContent = b64(JSON.stringify(j, null, 2));
      await ghPut(p.path, `${decision}: ${p.name}`, newContent, file.sha);

      if(j.issueNumber){
        const msg = `Entry ${p.name} has been **${decision}** by ${j.decidedBy}.`;
        await ghPostIssueComment(j.issueNumber, msg)
          .catch(e=>console.warn('Failed to comment on issue', e));
      }

      show('#global-status', `${decision} done for ${p.name}`);
      qs('#load-pending').click(); // refresh list

    }catch(err){
      show('#global-status','Decision failed: ' + (err.message || err), true);
    }
  }

})();
</script>

</body>
</html>
